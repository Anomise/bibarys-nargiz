name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout –∫–æ–¥
      uses: actions/checkout@v4
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: npm ci
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ TypeScript
      run: npm run type-check || npx tsc --noEmit
    
    - name: –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞
      run: npm run lint || npx eslint .
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      run: npm run format:check || npx prettier --check .
    
    - name: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: npm test
      env:
        CI: true
    
    - name: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
      run: npm run build
    
    - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.node-version }}
        path: dist/
        retention-days: 7
    
    # –î–µ–ø–ª–æ–π —Ç–æ–ª—å–∫–æ –¥–ª—è main/master –∏ Node.js 20.x
    - name: –î–µ–ø–ª–æ–π –Ω–∞ production
      if: github.ref == 'refs/heads/main' && matrix.node-version == '20.x'
      run: |
        echo "üöÄ –î–µ–ø–ª–æ–π –Ω–∞ production —Å–µ—Ä–≤–µ—Ä"
        # –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à–∏ –∫–æ–º–∞–Ω–¥—ã –¥–µ–ø–ª–æ—è
        # npm run deploy
      env:
        DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
    
    - name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      if: success()
      run: echo "‚úÖ Build –∏ deploy —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"
